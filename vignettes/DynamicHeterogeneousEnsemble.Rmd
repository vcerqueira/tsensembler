---
title: "Dynamic and Heterogeneous Ensembles\ for Time Series Forecasting"
author: "Vítor Cerqueira, Luís Torgo, Mariana Oliveira and Bernhard Pfahringer"
date: '`r Sys.Date()`'
output:
  html_document:
    toc: yes
  pdf_document:
    fig_caption: yes
    toc: yes
vignette: |
  %\VignetteIndexEntry{Vignette Title} %\VignetteEngine{knitr::rmarkdown} %\VignetteEncoding{UTF-8}
---

# Introduction

This vignette provides a brief tutorial for the package tsensembler. This package addresses the issue of ensemble methods for time series forecasting tasks. In order to allow for the use of such methods, time series are embedded into an higher dimensional space according to Time Delay Embedding (Takens, 1981). Concept drift adaptation in the ensemble is performed in an active manner, by dynamically combining base learners according to their recent performance. Diversity in the ensembles is encouraged with several strategies that include heterogeneity among learners, sampling techniques and computation of extra predictors. Heterogeneity is used with the goal of better coping with different dynamic regimes of the time series. The driving hypotheses of this package are that:   

i) Heterogeneous ensembles should better fit different dynamic regimes and
ii) Dynamic aggregation should allow for fast detection and adaptation to regime changes.

## Motivation

The idea of this package is to encourage reproducible research which the authors strongly support. In this document we present a brief tutorial to help the user build a dynamic ensemble for time series forecasting tasks. Scientific evidence is under peer review.

# Dynamic Heterogeneous Ensemble

We will use a time series related to water consumption. We embed the time series and then create an ensemble with several base learners, such as `SVM`, `Gaussian Processes`, `Ruled-based regression`, `Random Forests`, `Generalized Linear Models` with LASSO, Ridge and Elastic-Net regularization or `Projection Pursuit Regression`. Afterwards, we use this model to forecast future values of the series.

We start by installing the package from Github and loading it into our environment:

```{r, eval=FALSE, message=FALSE, warning=FALSE, include=TRUE}
devtools::install_github("vcerqueira/tsensembler") 
```

```{r, message=FALSE, warning=FALSE}
library(tsensembler)
```


## Time Delay Embedding

In our dynamic and heterogeneous ensemble implemented in `tsensembler` we address the task of time series forecasting by embedding the time series into an Euclidean space.

We load a time series of water consumption that is included in our package.
```{r}
data("water_consumption")

Y <- water_consumption[1:300]
```

The following figure illustrates the overall structure and dynamics of the time series.
```{r, fig.cap = "Your figure caption."}
plot.ts(Y)
```

To apply the standard regression toolbox we embed the time series into an higher dimensional space using Time Delay Embedding (Takens, 1981).

```{r}
embedded_Y <- embed.timeseries(Y, embedding.dimension = 10)
```

This renders the time series in the following matricial form:
```{r, echo=FALSE, results='asis'}
knitr::kable(head(embedded_Y, 6))
```

## Training Base Models

To train the base models we first define them and their parameter setting. For a complete description of models available type `?TSE`.

```{r}
base.models <- c('MARS', 'GLM','FFNN', 'RandomForest','PPR', 'SVM')

base.models.pars <- list(ffnn = list(size = c(10, 30), decay = c(0, 0.05), maxit = 750),
                         mars = list(nk   = c(3),   degree= c(2)),
                         rf = list(num.trees = c(1000), mtry = c(2, 3)),
                         glm = list(alpha = c(1, 0)), 
                         ppr = list(nterms = c(4)),
                         svm = list(kernel = c("rbfdot")))

```

```{r}
base_models <- Learntse(embedded_Y, target ~.,
                        learner = base.models,
                        learner.pars = base.models.pars,
                        embedding.dimension = 10, nstats = 0, verbose = FALSE)

dynamic_ensemble <- tseModel(baseModels = base_models$learningModels,
                             preWeights = base_models$preweights,
                             form = target ~.,
                             ma.N = 50,
                             embedding.dimension = 10,
                             committee.ratio = .2,
                             aggregationFUN = "emase-wcommittee",
                             Mstar = base_models$Mstar)

show(dynamic_ensemble)
```

We have an ensemble ready for forecasting next values of water consumption levels. To perform forecasts we have the function `forecast`:

```{r, eval=FALSE}
forecast(dynamic_ensemble, Y, h = 10)
```

To predict on some ready embedded data (i.e. a test set in a similar matricial form) we use the function `predict`, as standard in the R predictive models:

```{r}
predict(dynamic_ensemble, embedded_Y)
```


